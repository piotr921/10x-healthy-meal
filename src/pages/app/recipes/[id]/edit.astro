---
import AppLayout from '@/layouts/AppLayout.astro';
import RecipeForm from '@/components/my-recipes/RecipeForm';
import { RecipeService } from '@/lib/services/recipe.service';
import { isValidUUID } from '@/lib/validation/uuid.validation';
import { DEFAULT_USER_ID } from '@/db/supabase.client';
import type { RecipeDTO } from '@/types';

// Disable prerendering for this dynamic route
export const prerender = false;

// Get the recipe ID from the URL parameters
const { id } = Astro.params;

// Guard clause: validate recipe ID exists
if (!id) {
  return Astro.redirect('/app/recipes');
}

// Guard clause: validate UUID format
if (!isValidUUID(id)) {
  return Astro.redirect('/app/recipes');
}

// Fetch recipe data
const supabase = Astro.locals.supabase;
const recipeService = new RecipeService(supabase);

let recipe: RecipeDTO | null = null;
let errorMessage: string | null = null;

try {
  recipe = await recipeService.getRecipeById(DEFAULT_USER_ID, id);

  // Guard clause: recipe not found
  if (!recipe) {
    errorMessage = 'Recipe not found';
  }
} catch (error) {
  console.error('Error fetching recipe:', error);
  errorMessage = 'Failed to load recipe';
}
---

<AppLayout title={recipe ? `Edit ${recipe.title}` : 'Edit Recipe'}>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-6">
      <a
        href={recipe ? `/app/recipes/${recipe.id}` : '/app/recipes'}
        class="text-primary hover:underline inline-flex items-center gap-2"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Back to {recipe ? 'Recipe' : 'My Recipes'}
      </a>
    </div>

    <h1 class="text-3xl font-bold mb-6">Edit Recipe</h1>

    {errorMessage ? (
      <div class="bg-destructive/10 border border-destructive text-destructive px-6 py-4 rounded-lg">
        <h2 class="font-semibold mb-2">Error</h2>
        <p>{errorMessage}</p>
        <a href="/app/recipes" class="inline-block mt-4 text-sm underline hover:no-underline">
          Return to My Recipes
        </a>
      </div>
    ) : recipe ? (
      <RecipeForm client:load recipe={recipe} isEditMode={true} />
    ) : null}
  </div>
</AppLayout>

